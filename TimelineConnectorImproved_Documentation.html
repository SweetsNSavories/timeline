<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TimelineConnectorImproved.js Documentation</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        h1, h2, h3 { color: #2a4d7a; }
        code { background: #f4f4f4; padding: 2px 4px; border-radius: 3px; }
        pre { background: #f4f4f4; padding: 1em; border-radius: 5px; }
        .method { margin-bottom: 2em; }
    </style>
</head>
<body>
    <h1>TimelineConnectorImproved.js Documentation</h1>
    <p>This document explains the structure and implementation of <b>TimelineConnectorImproved.js</b>, a robust custom connector for the Power Apps Timeline control. This connector is designed to be registered as a Timeline record source and is not intended to be called from form load or ribbon scripts.</p>

    <h2>Class: <code>VirtualEntitySecondaryRecordSource</code></h2>
    <p>This class implements the required interface for a custom Timeline record source. It is responsible for initializing context, fetching and filtering records, and formatting them for Timeline display.</p>

    <div class="method">
        <h3><code>init(context)</code></h3>
        <p><b>Purpose:</b> Initializes the connector with the Timeline control's context.</p>
        <ul>
            <li>Stores the context object for later use.</li>
            <li>Retrieves the current AccountId from <code>context.parameters.tableContext.id</code>.</li>
            <li>Provides a fallback to <code>Xrm.Page</code> for legacy support.</li>
            <li>Loads the SVG icon resource for use in Timeline records.</li>
        </ul>
        <pre>this.context = context;
this.svgIconSrcPath = Xrm.Utility.getGlobalContext().getWebResourceUrl("msdyn_cec_Available.svg");
this.accountId = context?.parameters?.tableContext?.id || null;
// Fallback for legacy
if (!this.accountId) { ... }</pre>
    </div>

    <div class="method">
        <h3><code>getRecordSourceInfo()</code></h3>
        <p><b>Purpose:</b> Returns metadata about the connector, such as its display name.</p>
        <pre>return { name: "VirtualEntitySecondaryRecordSource" };</pre>
    </div>

    <div class="method">
        <h3><code>getRecordsData(request, filter)</code></h3>
        <p><b>Purpose:</b> Called by the Timeline control to fetch records for display.</p>
            <h1>TimelineConnectorImproved.js Documentation (with Logging)</h1>
            <p>This document explains the structure and implementation of <b>TimelineConnectorImproved.js</b>, a robust custom connector for the Power Apps Timeline control. <b>Console logging</b> is used throughout for debugging and lifecycle tracing. This connector is designed to be registered as a Timeline record source and is not intended to be called from form load or ribbon scripts.</p>
            <li>Checks if <code>accountId</code> is available; if not, returns an empty result.</li>
            <li>Calls <code>fetchAllRecords()</code> to retrieve filtered email records.</li>
            <li>Applies additional Timeline filter logic if provided.</li>
            <li>Sorts and paginates the records as required by the Timeline control.</li>
        </ul>
        <pre>// Fetch and filter records
let recordsData = yield this.fetchAllRecords();
// Apply Timeline filter if present
if (filter?.filterData?.length > 0) { ... }
// Sort and paginate
this.orderRecordsData(recordsData, request.isAscending);
                    <li><span style="color: #006400; font-weight: bold;">Logs the context and resolved AccountId for debugging.</span></li>
...</pre>
    </div>

    <div class="method">
        <h3><code>fetchAllRecords()</code></h3>
        <p><b>Purpose:</b> Retrieves all email records related to the current Account and matching the custom optionset value.</p>
        <ul>
            <li>Builds an OData filter to select only relevant emails.</li>
            <li>Uses <code>this.context.webAPI.retrieveMultipleRecords</code> to fetch data from Dataverse.</li>
            <li>Processes the raw records into Timeline format.</li>
        </ul>
        <pre>const filter = `$filter=mrc_methodofcommunication ne 4 and _regardingobjectid_value eq ${this.accountId}`;
let sampleRawRecords = yield this.context.webAPI.retrieveMultipleRecords("email", `?${filter}`);
if (sampleRawRecords?.entities.length) {
    recordsData = this.processRecordsData(sampleRawRecords.entities);
}</pre>
    </div>

    <div class="method">
        <h3><code>processRecordsData(rawRecordsData)</code></h3>
        <p><b>Purpose:</b> Converts raw email records into the format required by the Timeline control.</p>
        <ul>
            <li>Maps each email entity to a Timeline record object with <code>id</code>, <code>sortDateValue</code>, and <code>data</code> (stringified details).</li>
        </ul>
        <pre>rawRecordsData.forEach(element => {
    let recordData = {
        id: element.activityid,
        sortDateValue: element.createdon,
        data: JSON.stringify({
            id: element.activityid,
            name: element.sender,
            airDate: element.subject,
        })
    };
    recordsData.push(recordData);
});</pre>
    </div>

    <div class="method">
        <h3>Other Methods (not shown)</h3>
        <ul>
            <li><code>getFilterDetails</code>: Handles Timeline filter UI (if needed).</li>
            <li><code>getRecordUX</code>: Formats each record for Timeline display (header, body, footer, icons, commands).</li>
            <li><code>orderRecordsData</code>, <code>getRecordsAfterLastItem</code>: Support sorting and paging.</li>
        </ul>
    </div>

    <h2>Implementation Notes</h2>
    <ul>
        <li>This connector is designed to be registered as a Timeline record source in the control's configuration, not called from form load or ribbon scripts.</li>
        <li>All context and filtering is handled by the Timeline control lifecycle.</li>
        <li>OData filtering ensures only relevant records are retrieved from Dataverse, improving performance and accuracy.</li>
        <li>The code is modular and ready for extension (e.g., more filters, error handling, UI customization).</li>
    </ul>

    <h2>References</h2>
    <ul>
        <li><a href="https://learn.microsoft.com/en-us/power-apps/maker/model-driven-apps/custom-connectors-timeline-control" target="_blank">Microsoft Docs: Custom connectors for Timeline control</a></li>
        <li><a href="https://kerner.digital/?p=77" target="_blank">Kerner Blog: Custom Records on your timeline</a></li>
        <li><a href="https://learn.microsoft.com/en-us/power-apps/developer/model-driven-apps/clientapi/reference/xrm-webapi" target="_blank">Xrm.WebApi Reference</a></li>
    </ul>
</body>
</html>
