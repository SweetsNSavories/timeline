var SampleNamespace = SampleNamespace || {};
SampleNamespace.ShipmentRecordSource = class {
  constructor() { 
    this._moduleName = "ShipmentConnector";
    this._recordsCache = null;
  }

  init(ctx) { 
    this._context = ctx; 
    return Promise.resolve(); 
  }

  async getRecordsData(req, filter) {
    try {
      console.log("[ShipmentRecordSource] getRecordsData called", { searchKeyword: req.searchKeyword, filter: filter?.filterData?.length });
      
      // Fetch records once and cache them
      if (!this._recordsCache) {
        this._recordsCache = await this._fetchAllRecords();
        console.log("[ShipmentRecordSource] Cached", this._recordsCache.length, "records");
      }
      
      let recordsData = [...this._recordsCache];
      
      // Apply filters if any selected
      if (filter?.filterData && filter.filterData.length > 0) {
        recordsData = this._applyFilters(recordsData, filter.filterData);
        console.log("[ShipmentRecordSource] After filter:", recordsData.length, "records");
      }
      
      // Apply search if keyword provided
      if (req.searchKeyword) {
        recordsData = this._applySearch(recordsData, req.searchKeyword);
        console.log("[ShipmentRecordSource] After search for '", req.searchKeyword, "':", recordsData.length, "records");
      }
      
      // Sort by date
      this._sortRecords(recordsData, req.isAscending);
      
      // Handle pagination
      let paginated = this._getPaginatedRecords(recordsData, req);
      
      console.log("[ShipmentRecordSource] Returning', paginated.length, 'records for page");
      return { requestId: req.requestId, records: paginated, hasMoreRecords: recordsData.length > paginated.length };
    } catch (e) { 
      console.error("[ShipmentRecordSource] Error in getRecordsData:", e); 
      return { requestId: req.requestId, records: [] }; 
    }
  }

  async _fetchAllRecords() {
    let q = `?$select=crbff_title,crbff_field1,crbff_field2,crbff_field3,crbff_field4,crbff_externalprimarykey`;
    let res = await this._context.webAPI.retrieveMultipleRecords("crbff_shipments", q);
    console.log("[ShipmentRecordSource] _fetchAllRecords returned", res.entities?.length, "records");
    return (res.entities || []).map(i => ({ 
      id: i.crbff_shipmentsid, 
      sortDateValue: i.createdon || new Date().toISOString(), 
      data: JSON.stringify(i) 
    }));
  }

  _applyFilters(records, filterData) {
    let selectedValues = [];
    filterData.forEach(g => {
      g.options.forEach(o => {
        if (o.isSelected) selectedValues.push(o.value);
      });
    });
    
    if (selectedValues.length === 0) return records;
    
    return records.filter(rec => {
      let data = JSON.parse(rec.data);
      return selectedValues.includes(data.crbff_field1);
    });
  }

  _applySearch(records, keyword) {
    let searchTerm = keyword.toLowerCase();
    return records.filter(rec => {
      let data = JSON.parse(rec.data);
      let searchable = `${data.crbff_title || ''} ${data.crbff_field1 || ''} ${data.crbff_field3 || ''} ${data.crbff_field4 || ''}`.toLowerCase();
      return searchable.includes(searchTerm);
    });
  }

  _sortRecords(records, isAscending) {
    records.sort((a, b) => {
      let dateA = new Date(a.sortDateValue).getTime();
      let dateB = new Date(b.sortDateValue).getTime();
      return isAscending ? dateA - dateB : dateB - dateA;
    });
  }

  _getPaginatedRecords(records, req) {
    let start = 0;
    if (req.lastItem) {
      let lastIndex = records.findIndex(r => r.id === req.lastItem.id);
      if (lastIndex !== -1) start = lastIndex + 1;
    }
    return records.slice(start, start + (req.pageSize || 10));
  }

  getFilterDetails() { 
    return Promise.resolve([
      { 
        name: "ShipmentStatus", 
        label: "Status", 
        type: "MultiSelect", 
        isExpanded: true, 
        options: [
          { value: "Shipped", label: "Shipped" }, 
          { value: "Delivered", label: "Delivered" },
          { value: "Pending", label: "Pending" }
        ] 
      }
    ]); 
  }

  getRecordUX(data) {
    let item = JSON.parse(data.data);
    let factory = this._context.factory;
    return { 
      id: data.id, 
      moduleName: this._moduleName, 
      sortDateValue: data.sortDateValue,
      searchText: `${item.crbff_title} ${item.crbff_field1} ${item.crbff_field3} ${item.crbff_field4}`,
      header: { 
        components: [
          factory.createElement("Label", { key: "h", style: { fontWeight: "bold" } }, item.crbff_title || "No Title")
        ] 
      },
      body: { 
        components: [
          factory.createElement("Label", { key: "b" }, `Status: ${item.crbff_field1} | To: ${item.crbff_field3}`)
        ] 
      },
      footer: { 
        components: [
          factory.createElement("Label", { key: "f" }, `Tracking: ${item.crbff_field4}`)
        ] 
      } 
    };
  }
};
